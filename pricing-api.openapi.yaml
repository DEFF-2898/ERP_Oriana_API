openapi: 3.1.0
info:
  title: Oriana ERP - Pricing API
  version: 1.1.0
  description: API para gestión de listas de precios, ítems y consulta de tarifa aplicable.
  contact:
    name: Oriana ERP
    email: support@oriana.hotel.erp
  license:
    name: Proprietary
servers:
  - url: /api/v1
tags:
  - name: price-lists
    description: Gestión de listas de precios de la propiedad.
  - name: price-list-items
    description: Ítems (tarifas) dentro de una lista de precios.
  - name: pricing
    description: Consulta de tarifa aplicable (quote).
security:
  - bearerAuth: []
paths:
  /price-lists:
    post:
      tags:
        - price-lists
      operationId: createPriceList
      summary: Crear lista de precios
      description: Crea una nueva lista de precios para la propiedad, definiendo nombre, vigencia y estado inicial.
      parameters:
        - $ref: "#/components/parameters/XPropertyId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PriceListCreateRequest"
      responses:
        "201":
          description: Lista de precios creada.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PriceListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalServerError"
    get:
      tags:
        - price-lists
      operationId: listPriceLists
      summary: Listar listas de precios
      description: Devuelve el listado de listas de precios de la propiedad. Permite filtrar por estado activo.
      parameters:
        - $ref: "#/components/parameters/XPropertyId"
        - name: active
          in: query
          required: false
          description: Filtra por listas activas/inactivas (is_active).
          schema:
            type: boolean
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
      responses:
        "200":
          description: Listado de listas de precios.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PriceListListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"
  /price-lists/{priceListId}:
    get:
      tags:
        - price-lists
      operationId: getPriceList
      summary: Obtener lista de precios
      description:
        Devuelve el detalle completo de una lista de precios específica, incluyendo su vigencia y configuración
        general.
      parameters:
        - $ref: "#/components/parameters/XPropertyId"
        - $ref: "#/components/parameters/PriceListId"
      responses:
        "200":
          description: Detalle de lista de precios.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PriceListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"
    put:
      tags:
        - price-lists
      operationId: updatePriceList
      summary: Actualizar lista de precios (reemplazo)
      description: Actualiza de forma completa una lista de precios existente, reemplazando los datos previamente registrados.
      parameters:
        - $ref: "#/components/parameters/XPropertyId"
        - $ref: "#/components/parameters/PriceListId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PriceListUpdateRequest"
      responses:
        "200":
          description: Lista de precios actualizada.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PriceListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalServerError"
    patch:
      tags:
        - price-lists
      operationId: patchPriceList
      summary: Actualizar lista de precios (parcial)
      description:
        Actualiza parcialmente una lista de precios. Útil para activar/desactivar o modificar vigencia sin reemplazar
        el registro completo.
      parameters:
        - $ref: "#/components/parameters/XPropertyId"
        - $ref: "#/components/parameters/PriceListId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PriceListPatchRequest"
      responses:
        "200":
          description: Lista de precios actualizada.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PriceListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalServerError"
  /price-lists/{priceListId}/items:
    get:
      tags:
        - price-list-items
      operationId: listPriceListItems
      summary: Listar ítems de lista de precios
      description: Devuelve los ítems de una lista de precios, permitiendo filtrar por servicio y tipo de habitación.
      parameters:
        - $ref: "#/components/parameters/XPropertyId"
        - $ref: "#/components/parameters/PriceListId"
        - $ref: "#/components/parameters/ServiceCode"
        - $ref: "#/components/parameters/RoomTypeId"
        - name: active
          in: query
          required: false
          description: Filtra por ítems activos/inactivos (is_active).
          schema:
            type: boolean
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
      responses:
        "200":
          description: Listado de ítems.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PriceListItemListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"
    post:
      tags:
        - price-list-items
      operationId: createPriceListItem
      summary: Crear ítem de lista de precios
      description:
        Crea un nuevo ítem dentro de una lista de precios, asociando un servicio cobrable a un precio y vigencia
        determinada.
      parameters:
        - $ref: "#/components/parameters/XPropertyId"
        - $ref: "#/components/parameters/PriceListId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PriceListItemCreateRequest"
      responses:
        "201":
          description: Ítem creado.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PriceListItemResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalServerError"
  /price-lists/{priceListId}/items/{itemId}:
    put:
      tags:
        - price-list-items
      operationId: updatePriceListItem
      summary: Actualizar ítem (reemplazo)
      description: Actualiza de forma completa un ítem de una lista de precios existente.
      parameters:
        - $ref: "#/components/parameters/XPropertyId"
        - $ref: "#/components/parameters/PriceListId"
        - $ref: "#/components/parameters/ItemId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PriceListItemUpdateRequest"
      responses:
        "200":
          description: Ítem actualizado.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PriceListItemResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalServerError"
    patch:
      tags:
        - price-list-items
      operationId: patchPriceListItem
      summary: Actualizar ítem (parcial)
      description:
        Actualiza parcialmente un ítem de la lista de precios, permitiendo modificar su estado o vigencia sin reemplazar
        el registro completo.
      parameters:
        - $ref: "#/components/parameters/XPropertyId"
        - $ref: "#/components/parameters/PriceListId"
        - $ref: "#/components/parameters/ItemId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PriceListItemPatchRequest"
      responses:
        "200":
          description: Ítem actualizado.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PriceListItemResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalServerError"
  /pricing/quote:
    get:
      tags:
        - pricing
      operationId: getPricingQuote
      summary: Obtener tarifa aplicable (quote)
      description:
        Devuelve el precio aplicable para un servicio y tipo de habitación en una fecha específica, resolviendo
        automáticamente la vigencia correcta de la tarifa.
      parameters:
        - $ref: "#/components/parameters/XPropertyId"
        - $ref: "#/components/parameters/ServiceCodeRequired"
        - $ref: "#/components/parameters/RoomTypeIdOptional"
        - name: date
          in: query
          required: true
          description: Fecha para la cual se desea resolver la tarifa.
          schema:
            type: string
            format: date
      responses:
        "200":
          description: Tarifa aplicable encontrada.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PricingQuoteResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    XPropertyId:
      name: X-Property-Id
      in: header
      required: true
      description: Identificador de la propiedad (hotel.property.id).
      schema:
        type: integer
        format: int64
        minimum: 1
    PriceListId:
      name: priceListId
      in: path
      required: true
      schema:
        type: integer
        format: int64
        minimum: 1
    ItemId:
      name: itemId
      in: path
      required: true
      schema:
        type: integer
        format: int64
        minimum: 1
    ServiceCode:
      name: serviceCode
      in: query
      required: false
      description: Código del servicio (catalog.service.code).
      schema:
        type: string
        minLength: 1
        maxLength: 30
    ServiceCodeRequired:
      name: serviceCode
      in: query
      required: true
      description: Código del servicio (catalog.service.code).
      schema:
        type: string
        minLength: 1
        maxLength: 30
    RoomTypeId:
      name: roomTypeId
      in: query
      required: false
      description: Id de tipo de habitación (hotel.room_type.id).
      schema:
        type: integer
        format: int64
        minimum: 1
    RoomTypeIdOptional:
      name: roomTypeId
      in: query
      required: false
      description: Id de tipo de habitación (hotel.room_type.id). Si no aplica, omitir.
      schema:
        type: integer
        format: int64
        minimum: 1
    Limit:
      name: limit
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 50
      description: Tamaño de página.
    Offset:
      name: offset
      in: query
      required: false
      schema:
        type: integer
        minimum: 0
        default: 0
      description: Desplazamiento para paginación.
  schemas:
    Money:
      type: object
      properties:
        amount:
          type: number
          multipleOf: 0.01
        currency:
          type: string
          minLength: 3
          maxLength: 3
          description: "ISO-4217 (ej: PEN, USD)."
      required:
        - amount
    PriceListCreateRequest:
      type: object
      additionalProperties: false
      properties:
        code:
          type: string
          maxLength: 20
          description: Código único por propiedad (hotel.price_list.code).
        name:
          type: string
          maxLength: 100
        description:
          type: string
        validFrom:
          type: string
          format: date
        validTo:
          type:
            - string
            - "null"
          format: date
        isActive:
          type: boolean
          default: true
      required:
        - code
        - name
        - validFrom
    PriceListUpdateRequest:
      allOf:
        - $ref: "#/components/schemas/PriceListCreateRequest"
      description: Reemplazo completo. Incluye los campos gestionables del negocio.
    PriceListPatchRequest:
      type: object
      additionalProperties: false
      properties:
        name:
          type: string
          maxLength: 100
        description:
          type: string
        validFrom:
          type: string
          format: date
        validTo:
          type:
            - string
            - "null"
          format: date
        isActive:
          type: boolean
      minProperties: 1
    PriceListResponse:
      type: object
      additionalProperties: false
      properties:
        id:
          type: integer
          format: int64
        propertyId:
          type: integer
          format: int64
        code:
          type: string
          maxLength: 20
        name:
          type: string
          maxLength: 100
        description:
          type:
            - string
            - "null"
        validFrom:
          type: string
          format: date
        validTo:
          type:
            - string
            - "null"
          format: date
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type:
            - string
            - "null"
          format: date-time
      required:
        - id
        - propertyId
        - code
        - name
        - validFrom
        - isActive
        - createdAt
    PriceListListResponse:
      type: object
      additionalProperties: false
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/PriceListResponse"
        meta:
          $ref: "#/components/schemas/PaginationMeta"
      required:
        - items
        - meta
    PriceListItemBase:
      type: object
      additionalProperties: false
      properties:
        serviceCode:
          type: string
          maxLength: 30
          description: catalog.service.code
        roomTypeId:
          type:
            - integer
            - "null"
          format: int64
          description: hotel.room_type.id (nullable si el servicio no depende de tipo de habitación)
        price:
          type: number
          multipleOf: 0.01
          description: hotel.price_list_item.price
        taxIncluded:
          type: boolean
          default: true
        defaultTaxRate:
          type:
            - number
            - "null"
          multipleOf: 0.01
          minimum: 0
          maximum: 100
          default: 18.0
        validFrom:
          type: string
          format: date
        validTo:
          type:
            - string
            - "null"
          format: date
        isActive:
          type: boolean
          default: true
      required:
        - serviceCode
        - price
        - validFrom
    PriceListItemCreateRequest:
      allOf:
        - $ref: "#/components/schemas/PriceListItemBase"
    PriceListItemUpdateRequest:
      allOf:
        - $ref: "#/components/schemas/PriceListItemBase"
    PriceListItemPatchRequest:
      type: object
      additionalProperties: false
      properties:
        price:
          type: number
          multipleOf: 0.01
        taxIncluded:
          type: boolean
        defaultTaxRate:
          type:
            - number
            - "null"
          multipleOf: 0.01
          minimum: 0
          maximum: 100
        validFrom:
          type: string
          format: date
        validTo:
          type:
            - string
            - "null"
          format: date
        isActive:
          type: boolean
        roomTypeId:
          type:
            - integer
            - "null"
          format: int64
      minProperties: 1
    PriceListItemResponse:
      type: object
      additionalProperties: false
      properties:
        id:
          type: integer
          format: int64
        priceListId:
          type: integer
          format: int64
        serviceId:
          type: integer
          format: int32
          description: catalog.service.id
        serviceCode:
          type: string
          maxLength: 30
        roomTypeId:
          type:
            - integer
            - "null"
          format: int64
        price:
          type: number
          multipleOf: 0.01
        taxIncluded:
          type: boolean
        defaultTaxRate:
          type:
            - number
            - "null"
          multipleOf: 0.01
        validFrom:
          type: string
          format: date
        validTo:
          type:
            - string
            - "null"
          format: date
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type:
            - string
            - "null"
          format: date-time
      required:
        - id
        - priceListId
        - serviceCode
        - price
        - taxIncluded
        - validFrom
        - isActive
        - createdAt
    PriceListItemListResponse:
      type: object
      additionalProperties: false
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/PriceListItemResponse"
        meta:
          $ref: "#/components/schemas/PaginationMeta"
      required:
        - items
        - meta
    PricingQuoteResponse:
      type: object
      additionalProperties: false
      properties:
        serviceCode:
          type: string
          maxLength: 30
        roomTypeId:
          type:
            - integer
            - "null"
          format: int64
        date:
          type: string
          format: date
        price:
          $ref: "#/components/schemas/Money"
        taxIncluded:
          type: boolean
        taxRate:
          type:
            - number
            - "null"
          multipleOf: 0.01
          minimum: 0
          maximum: 100
        priceList:
          type: object
          additionalProperties: false
          properties:
            id:
              type: integer
              format: int64
            code:
              type: string
              maxLength: 20
            name:
              type: string
              maxLength: 100
            validFrom:
              type: string
              format: date
            validTo:
              type:
                - string
                - "null"
              format: date
          required:
            - id
            - code
            - name
            - validFrom
        item:
          type: object
          additionalProperties: false
          properties:
            id:
              type: integer
              format: int64
            validFrom:
              type: string
              format: date
            validTo:
              type:
                - string
                - "null"
              format: date
            isActive:
              type: boolean
          required:
            - id
            - validFrom
            - isActive
      required:
        - serviceCode
        - date
        - price
        - taxIncluded
        - priceList
        - item
    PaginationMeta:
      type: object
      additionalProperties: false
      properties:
        limit:
          type: integer
          minimum: 1
        offset:
          type: integer
          minimum: 0
        total:
          type: integer
          minimum: 0
      required:
        - limit
        - offset
        - total
    ErrorResponse:
      type: object
      additionalProperties: false
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type:
            - object
            - array
            - string
            - "null"
      required:
        - code
        - message
  responses:
    BadRequest:
      description: Solicitud inválida.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Unauthorized:
      description: No autenticado/No autorizado.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    NotFound:
      description: Recurso no encontrado.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Conflict:
      description: Conflicto (por ejemplo, código duplicado por propiedad).
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    InternalServerError:
      description: Error inesperado.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
